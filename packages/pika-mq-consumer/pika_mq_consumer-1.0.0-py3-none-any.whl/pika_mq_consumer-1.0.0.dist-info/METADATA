Metadata-Version: 2.4
Name: pika-mq-consumer
Version: 1.0.0
Summary: ç®€åŒ–çš„RabbitMQæ¶ˆè´¹è€…åŒ…è£…å™¨ï¼Œæä¾›ç±»ä¼¼npmåŒ…çš„ç®€æ´API
Author-email: pika-mq-consumer <iyahe29@gmail.com>
Maintainer-email: pika-mq-consumer <iyahe29@gmail.com>
License: MIT
Project-URL: Homepage, https://github.com/yourusername/pika-mq-consumer
Project-URL: Documentation, https://pika-mq-consumer.readthedocs.io/
Project-URL: Repository, https://github.com/yourusername/pika-mq-consumer.git
Project-URL: Bug Tracker, https://github.com/yourusername/pika-mq-consumer/issues
Project-URL: Changelog, https://github.com/yourusername/pika-mq-consumer/blob/main/CHANGELOG.md
Keywords: rabbitmq,pika,mq,message-queue,consumer,amqp
Classifier: Development Status :: 5 - Production/Stable
Classifier: Intended Audience :: Developers
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: Topic :: System :: Networking
Classifier: Topic :: Internet
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Operating System :: OS Independent
Requires-Python: >=3.7
Description-Content-Type: text/markdown
Requires-Dist: pika>=1.3.0
Requires-Dist: requests>=2.25.0
Provides-Extra: dev
Requires-Dist: pytest>=6.0; extra == "dev"
Requires-Dist: pytest-cov>=2.0; extra == "dev"
Requires-Dist: black>=21.0; extra == "dev"
Requires-Dist: flake8>=3.8; extra == "dev"
Requires-Dist: mypy>=0.900; extra == "dev"
Provides-Extra: docs
Requires-Dist: sphinx>=4.0; extra == "docs"
Requires-Dist: sphinx-rtd-theme>=1.0; extra == "docs"

# Pika MQ Consumer

[![PyPI version](https://badge.fury.io/py/pika-mq-consumer.svg)](https://badge.fury.io/py/pika-mq-consumer)
[![Python version](https://img.shields.io/pypi/pyversions/pika-mq-consumer.svg)](https://pypi.org/project/pika-mq-consumer/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

ğŸš€ **ç®€åŒ–çš„RabbitMQæ¶ˆè´¹è€…åŒ…è£…å™¨** - æä¾›ç±»ä¼¼npmåŒ…çš„ç®€æ´APIï¼Œè®©æ‚¨è½»æ¾æ¶ˆè´¹RabbitMQæ¶ˆæ¯ï¼

## âœ¨ ç‰¹æ€§

- ğŸ¯ **ç®€æ´API** - ç±»ä¼¼npmåŒ…çš„ä½¿ç”¨ä½“éªŒ
- ğŸ”„ **è‡ªåŠ¨é‡è¿** - å†…ç½®é‡è¿æœºåˆ¶ï¼Œä¿è¯æœåŠ¡ç¨³å®šæ€§
- ğŸ¨ **è£…é¥°å™¨æ¨¡å¼** - ä¼˜é›…çš„æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œæ–¹å¼
- ğŸ“¦ **JSONæ”¯æŒ** - è‡ªåŠ¨JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
- ğŸ§µ **å¤šçº¿ç¨‹æ”¯æŒ** - æ”¯æŒåå°çº¿ç¨‹æ¶ˆè´¹
- âš™ï¸ **çµæ´»é…ç½®** - ä¸°å¯Œçš„é…ç½®é€‰é¡¹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
pip install pika-mq-consumer
```

### åŸºç¡€ç”¨æ³•

```python
import asyncio
import os
from pika_mq_consumer import MQConsumer

async def handle_message(content):
    """å¤„ç†æ¶ˆæ¯çš„å‡½æ•°"""
    print(f"æ”¶åˆ°æ¶ˆæ¯: {content}")
    # åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„ä¸šåŠ¡é€»è¾‘
    return "success"

async def main():
    # å®Œå…¨å‚è€ƒamqplib-initçš„é…ç½®æ–¹å¼
    await MQConsumer.init({
        'channel_name': 'my-queue',                    # é˜Ÿåˆ—åç§°
        'prefetch': 1,                                 # å¹¶å‘æ§åˆ¶
        'delay': 100,                                  # å»¶è¿ŸACK (æ¯«ç§’)
        'amqp_auto_link': os.getenv('RABBITMQ_CONFIG_URL'),  # è‡ªåŠ¨è·å–è¿æ¥é…ç½®
        'callback': handle_message,                    # æ¶ˆæ¯å¤„ç†å‡½æ•°
        'finish': lambda: print("ğŸ‰ æ¶ˆè´¹è€…å¯åŠ¨å®Œæˆï¼"),
    })

if __name__ == '__main__':
    # è®¾ç½®ç¯å¢ƒå˜é‡
    # export RABBITMQ_CONFIG_URL='https://your-api.com/config'
    asyncio.run(main())
    
    # ä¿æŒç¨‹åºè¿è¡Œ
    while True:
        time.sleep(1)
```

### é«˜çº§ç”¨æ³•

```python
import asyncio
import os
import time
from pika_mq_consumer import MQConsumer

async def process_order(content):
    """å¤„ç†è®¢å•æ¶ˆæ¯"""
    order_id = content.get('order_id')
    print(f"ğŸ›’ å¤„ç†è®¢å•: {order_id}")
    
    # æ¨¡æ‹Ÿè®¢å•å¤„ç†é€»è¾‘
    await asyncio.sleep(2)
    
    print(f"âœ… è®¢å•å¤„ç†å®Œæˆ: {order_id}")
    return "success"

def check_system_status():
    """æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼Œå†³å®šæ˜¯å¦å¯ä»¥é‡å¯"""
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥ã€å¤–éƒ¨æœåŠ¡çŠ¶æ€ç­‰
    return True

def init_hook(context):
    """åˆå§‹åŒ–é’©å­å‡½æ•°"""
    print("ğŸ”— MQè¿æ¥å·²å»ºç«‹")
    # å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œåˆå§‹åŒ–æ“ä½œ

async def start_consumer():
    await MQConsumer.init({
        'channel_name': os.getenv('QUEUE_NAME', 'order-queue'),
        'prefetch': 2,                                    # å¹¶å‘å¤„ç†2ä¸ªæ¶ˆæ¯
        'delay': 200,                                     # å»¶è¿Ÿ200ms ACK
        'amqp_auto_link': os.getenv('RABBITMQ_CONFIG_URL'),  # è‡ªåŠ¨è·å–é…ç½®
        'amqp_link': os.getenv('RABBITMQ_URL', ''),       # å¤‡ç”¨è¿æ¥åœ°å€
        'heartbeat': 10,                                  # å¿ƒè·³é—´éš”
        'timeout': 5000,                                  # è¿æ¥è¶…æ—¶
        'auto_reload': 60000,                             # è‡ªåŠ¨é‡è½½æ£€æŸ¥é—´éš”
        'pm_id': os.getenv('PM2_ID', '0'),               # PM2è¿›ç¨‹ID
        'callback': process_order,                        # æ¶ˆæ¯å¤„ç†å‡½æ•°
        'query_hook': check_system_status,                # ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        'init_hook': init_hook,                          # åˆå§‹åŒ–é’©å­
        'finish': lambda: print("ğŸ‰ æ¶ˆè´¹è€…å¯åŠ¨å®Œæˆï¼"),
    })

if __name__ == '__main__':
    asyncio.run(start_consumer())
    
    # ä¿æŒç¨‹åºè¿è¡Œ
    while True:
        time.sleep(1)
```

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ä½¿ç”¨å‰ï¼Œè¯·è®¾ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼š

```bash
# å¿…éœ€ï¼šRabbitMQé…ç½®APIåœ°å€
export RABBITMQ_CONFIG_URL='https://your-api.com/config/getRabbitMqQueryConfig.html?key=your-key'

# å¯é€‰ï¼šå¤‡ç”¨è¿æ¥åœ°å€
export RABBITMQ_URL='amqp://username:password@host:port/'

# å¯é€‰ï¼šé˜Ÿåˆ—åç§°
export QUEUE_NAME='your-queue-name'

# å¯é€‰ï¼šPM2è¿›ç¨‹IDï¼ˆç”¨äºè‡ªåŠ¨é‡è½½ï¼‰
export PM2_ID='0'

# è¿è¡Œç¨‹åº
python your_consumer.py
```

## ğŸ“š APIæ–‡æ¡£

### MQConsumer.init() æ–¹æ³•

å®Œå…¨å‚è€ƒ amqplib-init çš„é…ç½®æ–¹å¼ï¼š

#### é…ç½®å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|------|------|--------|------|
| `channel_name` | str | 'node-test-channel' | é˜Ÿåˆ—åç§° |
| `prefetch` | int | 1 | å¹¶å‘å¤„ç†æ¶ˆæ¯æ•°é‡ |
| `delay` | int | 0 | å»¶è¿ŸACKæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `callback` | callable | - | æ¶ˆæ¯å¤„ç†å‡½æ•° |
| `finish` | callable | - | åˆå§‹åŒ–å®Œæˆå›è°ƒ |
| `amqp_auto_link` | str | '' | è‡ªåŠ¨è·å–è¿æ¥é…ç½®çš„APIåœ°å€ |
| `amqp_link` | str | '' | å¤‡ç”¨RabbitMQè¿æ¥åœ°å€ |
| `heartbeat` | int | 5 | å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰ |
| `timeout` | int | 2000 | è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `auto_reload` | int | 0 | è‡ªåŠ¨é‡è½½æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼Œ0è¡¨ç¤ºç¦ç”¨ï¼‰ |
| `pm_id` | str | '0' | PM2è¿›ç¨‹ID |
| `query_hook` | callable | - | æŸ¥è¯¢é’©å­å‡½æ•° |
| `init_hook` | callable | - | åˆå§‹åŒ–é’©å­å‡½æ•° |

#### ä½¿ç”¨æ–¹å¼

##### åŸºæœ¬é…ç½®

```python
await MQConsumer.init({
    'channel_name': 'my-queue',
    'prefetch': 1,
    'callback': your_message_handler,
    'amqp_auto_link': os.getenv('RABBITMQ_CONFIG_URL'),
})
```

##### å®Œæ•´é…ç½®

```python
await MQConsumer.init({
    'channel_name': 'production-queue',
    'prefetch': 5,                                    # å¹¶å‘å¤„ç†5ä¸ªæ¶ˆæ¯
    'delay': 100,                                     # å»¶è¿Ÿ100ms ACK
    'amqp_auto_link': os.getenv('RABBITMQ_CONFIG_URL'),  # ä¸»è¦é…ç½®æ¥æº
    'amqp_link': os.getenv('RABBITMQ_URL'),           # å¤‡ç”¨è¿æ¥
    'heartbeat': 10,                                  # 10ç§’å¿ƒè·³
    'timeout': 5000,                                  # 5ç§’è¶…æ—¶
    'auto_reload': 30000,                             # 30ç§’æ£€æŸ¥é‡è½½
    'pm_id': '0',                                     # PM2è¿›ç¨‹ID
    'callback': process_message,                      # æ¶ˆæ¯å¤„ç†å‡½æ•°
    'finish': lambda: print("å¯åŠ¨å®Œæˆ"),               # å®Œæˆå›è°ƒ
    'query_hook': check_can_reload,                   # é‡è½½æ£€æŸ¥å‡½æ•°
    'init_hook': on_connection_ready,                 # è¿æ¥å°±ç»ªå›è°ƒ
})
```

### æ¶ˆæ¯å¤„ç†å™¨å‡½æ•°

æ¶ˆæ¯å¤„ç†å™¨å‡½æ•°åªæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼š

**content**: æ¶ˆæ¯å†…å®¹
- è‡ªåŠ¨JSONè§£æï¼ˆå¦‚æœæ˜¯JSONæ ¼å¼ï¼‰
- åŸå§‹å­—ç¬¦ä¸²ï¼ˆå¦‚æœä¸æ˜¯JSONï¼‰

```python
async def handle_message(content):
    """
    å¤„ç†æ¶ˆæ¯å‡½æ•°
    
    Args:
        content: æ¶ˆæ¯å†…å®¹ï¼ˆdict æˆ– strï¼‰
        
    Returns:
        str: å¤„ç†ç»“æœï¼ˆå¯é€‰ï¼‰
    """
    print(f"æ”¶åˆ°æ¶ˆæ¯: {content}")
    
    # å¤„ç†ä¸šåŠ¡é€»è¾‘
    if isinstance(content, dict):
        task_type = content.get('type')
        if task_type == 'order':
            await process_order(content)
        elif task_type == 'notification':
            await send_notification(content)
    
    return "success"  # å¯é€‰è¿”å›å€¼
```

**å¼‚å¸¸å¤„ç†ï¼š**
- å‡½æ•°æ­£å¸¸è¿”å›ï¼šæ¶ˆæ¯ACK
- æŠ›å‡ºå¼‚å¸¸ï¼šæ¶ˆæ¯NACKå¹¶é‡æ–°å…¥é˜Ÿ

## ğŸ› ï¸ å¼€å‘

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/yourusername/pika-mq-consumer.git
cd pika-mq-consumer

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows

# å®‰è£…å¼€å‘ä¾èµ–
pip install -e ".[dev]"

# è¿è¡Œæµ‹è¯•
pytest

# ä»£ç æ ¼å¼åŒ–
black .

# ç±»å‹æ£€æŸ¥
mypy pika_mq_consumer
```

### æ„å»ºå’Œå‘å¸ƒ

```bash
# æ„å»ºåŒ…
python -m build

# å‘å¸ƒåˆ°æµ‹è¯•PyPI
python -m twine upload --repository testpypi dist/*

# å‘å¸ƒåˆ°æ­£å¼PyPI
python -m twine upload dist/*
```

## ğŸ”§ é…ç½®ç¤ºä¾‹

### è¿æ¥é…ç½®

```python
# åŸºæœ¬è¿æ¥
consumer = MQConsumer(
    host='rabbitmq.example.com',
    port=5672,
    username='myuser',
    password='mypassword',
    virtual_host='/production'
)

# SSLè¿æ¥
consumer = MQConsumer(
    host='secure-rabbitmq.example.com',
    port=5671,
    username='myuser',
    password='mypassword',
    ssl_options={
        'ssl_version': ssl.PROTOCOL_TLS,
        'cert_reqs': ssl.CERT_REQUIRED,
        'ca_certs': '/path/to/ca_certificate.pem',
        'certfile': '/path/to/client_certificate.pem',
        'keyfile': '/path/to/client_key.pem',
    }
)
```

### é˜Ÿåˆ—é…ç½®

```python
# æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œæ‰‹åŠ¨ç¡®è®¤
@consumer.queue('important_queue', 
                durable=True, 
                auto_ack=False, 
                prefetch_count=1)
def handle_important(body, properties):
    # é‡è¦æ¶ˆæ¯å¤„ç†
    pass

# ä¸´æ—¶é˜Ÿåˆ—ï¼Œè‡ªåŠ¨ç¡®è®¤
@consumer.queue('temp_queue', 
                durable=False, 
                auto_delete=True, 
                auto_ack=True,
                prefetch_count=100)
def handle_temp(body, properties):
    # ä¸´æ—¶æ¶ˆæ¯å¤„ç†
    pass
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Forkæœ¬é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ†˜ æ”¯æŒ

- ğŸ“– [æ–‡æ¡£](https://pika-mq-consumer.readthedocs.io/)
- ğŸ› [é—®é¢˜æŠ¥å‘Š](https://github.com/yourusername/pika-mq-consumer/issues)
- ğŸ’¬ [è®¨è®º](https://github.com/yourusername/pika-mq-consumer/discussions)

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-09-21)
- ğŸ‰ é¦–æ¬¡å‘å¸ƒ
- âœ¨ åŸºç¡€æ¶ˆè´¹è€…åŠŸèƒ½
- ğŸ”„ è‡ªåŠ¨é‡è¿æœºåˆ¶
- ğŸ¨ è£…é¥°å™¨API
- ğŸ“¦ JSONæ”¯æŒ
- ğŸ§µ å¤šçº¿ç¨‹æ”¯æŒ
