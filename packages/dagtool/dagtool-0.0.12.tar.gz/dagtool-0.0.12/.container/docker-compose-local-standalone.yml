name: common
services:
  airflow:
    image: airflow-standalone-local
    container_name: airflow-dev
    build:
      context: ..
      dockerfile: ./.container/base.Dockerfile
      args:
        AIRFLOW_VERSION: ${AIRFLOW_VERSION:-2.7.1}
        PYTHON_VERSION: ${PYTHON_VERSION:-3.10}
    ports:
      - "8080:8080"
    command: [ "airflow", "standalone" ]
    environment:
      AIRFLOW_HOME: "/opt/airflow"
      AIRFLOW_CONFIG: "/opt/airflow/airflow.cfg"
      AIRFLOW_ENV: "${AIRFLOW_ENV:-dev}"
    volumes:
      - ${AIRFLOW_PROJ_DIR:-.}/dags:/opt/airflow/dags
      - ${AIRFLOW_PROJ_DIR:-.}/logs:/opt/airflow/logs
      - ${AIRFLOW_PROJ_DIR:-.}/.container/airflow.standalone.cfg:/opt/airflow/airflow.cfg
      - ${AIRFLOW_PROJ_DIR:-.}/.container/airflow_local_settings.py:/opt/airflow/config/airflow_local_settings.py
      # NOTE: Mount tool package suppose as it use GitSync on production instead
      #   of install via Python package.
      - ${AIRFLOW_PROJ_DIR:-.}/dagtool:/opt/airflow/dagtool
      - ${AIRFLOW_PROJ_DIR:-.}/standalone_admin_password.txt:/opt/airflow/standalone_admin_password.txt
