name: Release

on:
  push:
    branches:
      - main
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # this is needed to get all tags

      - name: Install uv and set the python version
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.10"  # 3.13 has issues so lets go w/ one we know works
      - name: Install the project
        run: uv sync --all-extras --dev
      - name: Install Invoke
        run: |
          pip install invoke

      - name: Extract version from pyproject.toml
        id: get_version
        run: |
          version=$(invoke get-version)
          if [ -z "$version" ]; then
              echo "Error: Version not found in pyproject.toml"
              exit 1
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          if [ $(git tag -l "v${{ steps.get_version.outputs.version }}") ]; then
              echo "Tag exists"
              echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
              echo "Tag does not exist"
              echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag and release
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag "v$VERSION"
          git push origin "v$VERSION"
          gh release create "v$VERSION" --title "Release v$VERSION" --notes "Automated release for version $VERSION"
