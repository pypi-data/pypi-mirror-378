---
Transform: AWS::Serverless-2016-10-31
Description: OMBU / Application / Cloudformation Update Pipeline

# The cloudformation-update-pipeline stack will create an AWS EventBridge
# listener for Cloudformation stack updates. When a Cloudformation stack update
# is detected it will trigger an AWS Lambda function to notifiy the user via
# AWS SNS about the change.

Parameters:

  ApplicationName:
    Description: The name of the application.
    Type: String

  EnvironmentType:
    Description: The environment of the application.
    Type: String

  ClusterName:
    Description: The name of the ECS Cluster that hosts the service.
    Type: String

  ServiceName:
    Description: The name the ECS service to deploy.
    Type: String

  ServiceNameArn:
    Description: The ARN the ECS service to deploy.
    Type: String

  ApplicationStackArn:
    Description: Application Stack ARN.
    Type: String

  NotificationArn:
    Description: The ARN of the SNS Topic to send notifications to.
    Type: String

  LogRetention:
    Description: How long to keep logs for in days.
    Default: 30
    Type: Number

Resources:

  CloudFormationOnUpdateRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-AllowLogging"
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:\
                          log-group:/aws/lambda/*"
        - PolicyName: !Sub "${AWS::StackName}-DescribeTask"
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ecs:DescribeTaskDefinition
                Resource: '*'
        - PolicyName: !Sub "${AWS::StackName}-AllowECSServiceUpdate"
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ecs:UpdateService
                  - ecs:DescribeServices
                  - ecs:DescribeTaskDefinition
                Resource:
                  - !Ref ServiceNameArn
                  - !Sub "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:\
                          service/${ClusterName}/${ServiceName}"
        - PolicyName: !Sub "${AWS::StackName}-SNSTopic"
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref NotificationArn

  CloudFormationOnUpdateLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${CloudFormationOnUpdate}"
      RetentionInDays: !Ref LogRetention

  CloudFormationOnUpdate:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../scripts/cloudformation_update
      Handler: cloudformation_update.handler
      Role: !GetAtt CloudFormationOnUpdateRole.Arn
      Runtime: python3.12
      Timeout: 600
      MemorySize: 128
      ReservedConcurrentExecutions: 1
      Description: Notify the SNS Topic of the CloudFormation update.
      Environment:
        Variables:
          CLUSTER: !Ref ClusterName
          SERVICE: !Ref ServiceName
          SERVICE_ARN: !Ref ServiceNameArn
          SERVICE_FRIENDLY_NAME: !Ref ApplicationName
          ENVIRONMENT_TYPE: !Ref EnvironmentType
          TOPIC_ARN: !Ref NotificationArn
      Events:
        CloudFormationEvent:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              resources:
                - !Ref ApplicationStackArn
              detail:
                stack-id:
                  - !Ref ApplicationStackArn
                status-details:
                  status:
                    - UPDATE_IN_PROGRESS
              detail-type:
                - CloudFormation Stack Status Change
              source:
                - aws.cloudformation

Outputs:

  LogGroup:
    Description: The CloudWatch log group.
    Value: !Ref CloudFormationOnUpdateLogGroup
