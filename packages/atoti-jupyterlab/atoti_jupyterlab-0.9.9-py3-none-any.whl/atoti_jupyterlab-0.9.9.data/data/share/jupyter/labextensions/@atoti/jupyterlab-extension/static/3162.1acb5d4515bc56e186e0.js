"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[3162],{53162:(e,t,a)=>{a.r(t),a.d(t,{default:()=>T});var n=a(74389),o=a(90147),s=a(31529),i=a(93345),r=a(95889),l=a(1424),u=a(80338),d=a(20024),c=a(57486),y=a(28229);function m(e){return e.substring(5,e.length-1).split(",")}var p=a(57421),x=a(6151),f=a(834),h=a(67373),g=a(4492),C=a(74667),v=a(99871);const b=e=>{const{formatMessage:t}=(0,r.useIntl)(),{onOk:a,onCancel:o,templatedName:s}=e,[l,u]=(0,i.useState)(""),[d,c]=(0,i.useState)(""),y=(e=>{const t=e.indexOf("$"),a=e.lastIndexOf("$");return e.substring(t,a+1)})(s),m=s.replace(y,l);return(0,n.FD)("div",{style:{width:400,display:"flex",flexDirection:"column"},children:[(0,n.FD)("div",{style:{flexGrow:1,marginBottom:8},children:[(0,n.Y)(C.Input,{style:{marginTop:4},placeholder:y,value:l,onChange:e=>u(e.target.value)}),(0,n.Y)(C.Input,{style:{marginTop:8},placeholder:"value",value:d,onChange:e=>c(e.target.value)})]}),(0,n.FD)(v.PopoverButtonGroup,{children:[(0,n.Y)(C.Button,{onClick:o,children:t({id:"aui.cancel"})}),(0,n.Y)(C.Button,{onClick:()=>{a(m,d)},disabled:0===l.length||0===d.length||e.queryContext?.some((({key:e})=>e===m)),type:"primary",children:t({id:"aui.ok"})})]})]})},N=e=>{let t;const[a,o]=(0,i.useState)(null),s=t=>{isNaN(Number(t))&&"ALL"!==e.type||e.onValueChanged?.(t)};if((0,i.useEffect)((()=>{"BOOL"!==e.type&&"ENUM"!==e.type&&o(e.value)}),[e.type,e.value]),"BOOL"===e.type)t=(0,n.Y)(C.Checkbox,{checked:"true"===e.value,disabled:e.isDisabled,onChange:()=>e.onValueChanged?.("true"===e.value?"false":"true")});else if(e.isDisabled)t=e.value;else if(e.type.startsWith("ENUM")){const a=m(e.type);t=(0,n.Y)(C.Select,{value:e.value,size:"small",onChange:e.onValueChanged,disabled:e.isDisabled,children:a.map((e=>(0,n.Y)(C.Select.Option,{value:e,children:e},e)))})}else t=(0,n.Y)(C.Input,{value:a??"",onChange:e=>o(e.target.value),onBlur:e=>{s(e.target.value)},onPressEnter:e=>{s(e.currentTarget.value)},size:"small",disabled:e.isDisabled});return(0,n.FD)("div",{css:{display:"flex",marginRight:16},children:[(0,n.Y)("div",{css:{flexGrow:1,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},title:e.name,children:e.name}),(0,n.Y)("div",{css:{textAlign:"right",flexGrow:1,flexShrink:1,marginLeft:10,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden",minWidth:35},children:t})]},e.name)},k=["drillthrough.hiddencolumns","subcube"],E=["mdx.kpi","mdx.member","mdx.formatters","mdx.set","mdx.measureAlias","mdx.defaultmembers","user-authentication"],I=["dashboard","page","widget"],K=(e,{sectionName:t,pageKey:a,leafKey:n})=>{const o="dashboard"===t?e:"page"===t?(0,c.W)(e,a):(0,y.B)(e,a,n);if(!o)throw new Error(`Impossible to edit the ${t}'s query context, as its corresponding state was not found.`);return o},w=(e,t,a)=>{e.queryContext||(e.queryContext=[]),e.queryContext.splice(a,0,t)},O=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:s,queryContextEntry:i,index:r})=>{let l=n,u=e;return"user"===s?l=(0,o.produce)(n,(e=>{e.splice(r,0,i)})):u=(0,o.produce)(e,(e=>{const n=K(e,{sectionName:s,pageKey:t,leafKey:a});w(n,i,r)})),[u,l]},Y=(e,t)=>{if(!e.queryContext)return;const{queryContext:a}=e;a.splice(t,1),0===a.length&&delete e.queryContext},S=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:s,index:i})=>{let r=n,l=e;return"user"===s?r=(0,o.produce)(n,(e=>{e.splice(i,1)})):l=(0,o.produce)(e,(e=>{const n=K(e,{sectionName:s,pageKey:t,leafKey:a});Y(n,i)})),[l,r]},T=(0,p.n)((e=>{const{dashboardState:t,pageKey:a,leafKey:c,onDashboardChange:y}=(0,l.M)(e)?e:{},{cube:p,dataModel:C}=(0,h.useCube)(e.widgetState),{widgetState:v,onWidgetChange:T}=e,{formatMessage:q}=(0,r.useIntl)(),[D,,]=(0,u.J)("canUseUserQueryContext");let _=I;D&&(_=["user",...I]);const Q=(0,f.useQueryContexts)({widgetState:v,dashboardState:t,pageKey:a}),[,R]=(0,d.v)("userQueryContext"),[P,B]=(0,i.useState)(),V=function(e){const t=e.contextValues,[a]=(0,u.J)("contextValues");return(0,i.useMemo)((()=>"*"===a?t:(0,s.pickBy)(t,(({name:e})=>a.some((t=>e===t))))),[a,t])}(C),M=(0,i.useCallback)((e=>{if(V[e])return V[e].type;const t=(0,s.findKey)(V,(({name:t})=>e.startsWith(t.replace(/\$.*\$$/,""))));return t?V[t].type:"ALL"}),[V]),U=(0,i.useMemo)((()=>{const e=Object.values(V).filter((({name:e})=>!k.some((t=>e.startsWith(t))))),t=(0,s.groupBy)(e,(({category:e})=>e||"misc"));return Object.entries(t).map((([e,t])=>({caption:e,isFolder:!0,isActionable:!1,type:e,children:t.map((t=>{const a={type:"QUERY_CONTEXT_ENTRY",key:t.name};return{caption:t.name,type:e,isActionable:!0,isDisabled:_.every((e=>Q[e]?.some((({key:e})=>e===t.name)))),dragItem:a}}))})))}),[V,Q,_]),L=(0,i.useMemo)((()=>{const e={};return e.default={placeholder:q({id:"aui.tool.queryContextEditor.noQueryContextEntries"}),caption:q({id:"aui.tool.queryContextEditor.defaultSection"}),tiles:Object.values(p.contextValues).filter((({name:e})=>E.every((t=>!e.startsWith(t)))&&k.every((t=>!e.startsWith(t))))).map((({name:e,value:t},a)=>{const o={key:e,value:t,fromPosition:{sectionName:"default",tileIndex:a},type:"QUERY_CONTEXT_ENTRY"};return{caption:(0,n.Y)(N,{name:e,value:t,isDisabled:!0,type:M(e)}),dragItem:o,isDisabled:_.some((t=>Q[t]?.some((({key:t})=>t===e)))),isRemovable:!1}}))},_.forEach((s=>{const i=Q[s];e[s]={caption:q({id:`aui.tool.queryContextEditor.${s}Section`}),tiles:i?i.map((({key:e,value:i},r)=>{const l={key:e,value:i,fromPosition:{sectionName:s,tileIndex:r},type:"QUERY_CONTEXT_ENTRY"},u=_.slice(_.indexOf(s)+1).some((t=>Q[t]?.some((t=>e===t.key))));return{caption:(0,n.Y)(N,{name:e,value:i,type:M(e),isDisabled:u,onValueChanged:e=>{if(y&&t&&a&&c)if("user"===s){if(!Q.user)return;const t=(0,o.produce)(Q.user,(t=>{t[r].value=e}));R(t)}else{const n=(0,o.produce)(t,(t=>{K(t,{leafKey:c,pageKey:a,sectionName:s}).queryContext[r].value=e}));y(n)}else{const t=(0,o.produce)(v,(t=>{t.queryContext[r].value=e}));T(t)}}}),isRemovable:!0,isDisabled:u,dragItem:l}})):[]}})),P&&e[P.sectionName].tiles.splice(P.tileIndex,0,{caption:P.key,dragItem:null}),e}),[P,M,p.contextValues,Q,t,q,c,y,T,a,v,R,_]),$=(0,i.useCallback)((({sectionName:e,tileIndex:n})=>{if(y&&t&&a&&c){const[o,s]=S({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:Q.user||[],sectionName:e,index:n});o!==t&&y(o),s!==Q.user&&R(s)}else{const e=(0,o.produce)(v,(e=>{Y(e,n)}));T(e)}}),[t,c,y,a,Q.user,v,T,R]),A=(0,i.useCallback)(((e,n,s)=>{const i=s??(Q[e]?.length||0);if(-1!==n.indexOf("$"))B({sectionName:e,tileIndex:i,key:n});else if("mdx.measureAliases"===n)B({sectionName:e,tileIndex:i,key:n+".$measure_name$"});else{const s={key:n,value:((e,t)=>{if(!e)return"";const a=t[e.name];if(e.type.startsWith("ENUM"))return m(e.type)[0];switch(e.type){case"BOOL":return void 0!==a?a.value:"true";case"LONG":case"INTEGER":case"DOUBLE":return void 0!==a?a.value:"0";default:return a?.value||""}})(V[n],p.contextValues)};if(y&&t&&a&&c){const[n,o]=O({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:Q.user||[],sectionName:e,queryContextEntry:s,index:i});n!==t&&y(n),o!==Q.user&&R(o)}else{const e=(0,o.produce)(v,(e=>{w(e,s,i)}));T(e)}}}),[V,t,c,y,T,a,Q,v,p.contextValues,R]),W=(0,i.useCallback)((e=>{e.isActionable&&!Q.widget?.some((({key:t})=>t===e.caption))&&A("widget",e.caption)}),[A,Q]),F=(0,i.useCallback)(((e,n)=>{if(P){const s={key:e,value:n};if(y&&t&&a&&c){const[e,n]=O({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:Q.user||[],sectionName:P.sectionName,queryContextEntry:s,index:P.tileIndex});e!==t&&y(e),n!==Q.user&&R(n)}else{const e=(0,o.produce)(v,(e=>{w(e,s,P.tileIndex)}));T(e)}B(void 0)}}),[t,c,y,T,a,P,v,R,Q.user]),G=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:n,tileIndex:o}})=>{if(y&&t&&a&&c){let s=t,i=Q.user??[];"default"!==e.fromPosition.sectionName&&([s,i]=S({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:Q.user||[],sectionName:e.fromPosition.sectionName,index:e.fromPosition.tileIndex})),"default"!==n&&([s,i]=O({dashboardState:s,pageKey:a,leafKey:c,userQueryContext:i||[],sectionName:n,index:o,queryContextEntry:{key:e.key,value:e.value}})),s!==t&&y(s),i!==Q.user&&R(i)}}),[t,c,y,a,R,Q.user]),j=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:t,tileIndex:a}})=>{A(t,e.key,a)}),[A]);return(0,n.FD)(f.ResizableEditor,{children:[(0,n.Y)(x.P,{value:U,isSearchVisible:!0,searchPlaceholder:q({id:"aui.tool.queryContextEditor.searchContextEntries"}),onClick:W,expandTrigger:"full-node"}),(0,n.Y)(g.s,{css:{overflow:"auto"},sections:L,dragItemTypes:["QUERY_CONTEXT_ENTRY"],canDrop:({dragItem:e,toPosition:{sectionName:t}})=>"QUERY_CONTEXT_ENTRY"===e.type&&"default"!==t&&e?.fromPosition?.sectionName!==t&&!Q[t]?.some((({key:t})=>t===e.key)),onTileRemoved:$,onTileMoved:G,onTileAdded:j,popoverProps:{title:q({id:"aui.tool.queryContextEditor.editContextValue"}),position:P,content:P&&(0,n.Y)(b,{onOk:F,templatedName:P.key,onCancel:()=>B(void 0),queryContext:Q[P.sectionName]})}})]})}))}}]);