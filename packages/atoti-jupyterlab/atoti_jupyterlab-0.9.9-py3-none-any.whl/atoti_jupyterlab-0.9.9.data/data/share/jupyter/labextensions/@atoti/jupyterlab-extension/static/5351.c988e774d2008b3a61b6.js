"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[5351],{45351:(e,t,l)=>{l.r(t),l.d(t,{default:()=>B});var n=l(74389),r=l(31529),o=l(93345),i=l(61386),a=l(47688),s=l(95889),c=l(19220),u=l(69326),d=l(83516),p=l(17523),m=l(40570);const f=e=>{const t=(0,o.useMemo)((()=>o.Children.toArray(e.children).reduce(((t,l,n)=>{const r=Math.floor(n/e.numberOfColumns),o=t[r]??[];return t[r]=[...o,l],t}),[])),[e.children,e.numberOfColumns]);return(0,n.Y)("div",{style:e.containerStyle,css:{paddingBottom:2,paddingRight:2,width:"100%",height:"100%"},children:(0,n.Y)("div",{css:{width:"100%",height:"100%",overflow:"auto"},children:(0,n.Y)("table",{css:m.css`
            border-spacing: 20px 10px;
            border-collapse: separate !important;
            width: 100%;
          `,children:(0,n.Y)("tbody",{children:t.map(((e,t)=>(0,n.Y)("tr",{children:e.map(((e,t)=>(0,n.Y)("td",{children:e},t)))},t)))})})})})};var h=l(67034),y=l(32867),g=l(62607),C=l(45064),b=l(5466),v=l(99871);const S=e=>{const t=(0,b.F)(),[l,r]=(0,o.useState)(e.title);return(0,o.useEffect)((()=>{r(e.title)}),[e.title]),(0,n.Y)(v.AutoSizedInput,{readOnly:t,value:l,onChange:r,onBlur:()=>{e.onTitleChange?.(l)}})},x=({differenceCell:e,referenceValue:t,measureStyle:l,isDifferenceInPercentage:n})=>{const r=Number(e?.value);return isNaN(r)||n&&isNaN(t)?"N/A":`${r>0?"+":""}${n?(0,y.m)({value:r/Math.abs(t),valueFormattedByAtotiServer:"N/A",numericFieldStyle:{numberFormat:"percentage",numberOfDecimals:2}}):(0,y.m)({value:r,valueFormattedByAtotiServer:e?.formattedValue??"N/A",numericFieldStyle:l})}`},w=({difference:e,referenceValue:t,theme:l,isDifferenceInPercentage:n})=>isNaN(e)||0===e||n&&isNaN(t)?l.textColor:e>0?l.successColor:l.errorColor,I=e=>{const t=(0,C.DP)(),{formatMessage:l}=(0,s.useIntl)(),{onTitleChange:a,title:c,isTime:u,tuple:d,onSelect:p,isSelected:m,differenceCell:f,style:b}=e,v=Number(e.referenceCell?.value),I=m?`${t.selectionOverlayColor}`:"none",M=(0,o.useMemo)((()=>{const e=d.find(h.t)?.namePath[0];return e?b?.measures?.[e]:void 0}),[d,b?.measures]),T=e.comparedCell&&(0,r.isNumber)(e.comparedCell.value)&&e.comparedCell.value<0,[[D,Y],[N,O]]=(0,o.useMemo)((()=>[e.referenceCell,e.comparedCell].map((e=>[(0,y.m)({value:Number(e?.value??0),valueFormattedByAtotiServer:e?.formattedValue??"N/A",numericFieldStyle:M}),(0,g.T)({fieldStyle:M,value:e?.value})]))),[M,e.referenceCell,e.comparedCell]);return(0,n.FD)("div",{style:{background:I,height:83,display:"flex",alignItems:"flex-end",padding:"0px 2px"},onMouseDown:e=>{(0===e.button||!m&&2===e.button)&&p({cell:f,tuple:d,isSelected:m})},children:[(0,n.Y)("span",{style:{borderLeft:`3px solid ${t.primaryColor}`,height:75}}),(0,n.FD)("div",{style:{display:"flex",paddingLeft:5,flexDirection:"column"},children:[(0,n.Y)(S,{title:c,onTitleChange:e=>{const t=(0,i.getTupleKey)(d);a?.({tupleKey:t,title:e})}}),(0,n.FD)("div",{style:{display:"flex"},children:[(0,n.FD)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"space-between",whiteSpace:"nowrap",paddingLeft:2},children:[(0,n.Y)("span",{style:{fontWeight:600,fontSize:20,lineHeight:1.5,color:O.backgroundColor||(T?t.errorColor:void 0)},children:N}),u?l({id:"aui.plugins.widget.kpi.on"},{value:e.comparedMemberCaption}):e.comparedMemberCaption]}),(0,n.Y)("span",{style:{margin:"8px 10px 3px",borderLeft:`1px solid ${t.grayScale[4]}`}}),(0,n.FD)("div",{style:{paddingTop:3,display:"flex",justifyContent:"space-around",flexDirection:"column",whiteSpace:"nowrap"},children:[(0,n.Y)("span",{style:{color:w({difference:Number(e.differenceCell?.value),referenceValue:v,theme:t,isDifferenceInPercentage:b?.isDifferenceInPercentage}),fontWeight:500},children:x({differenceCell:e.differenceCell,measureStyle:M,referenceValue:v,isDifferenceInPercentage:b?.isDifferenceInPercentage})}),(0,n.Y)("span",{style:{fontSize:9,color:Y.backgroundColor},children:l({id:"aui.plugins.widget.kpi.vs"},{value:D})}),u?l({id:"aui.plugins.widget.kpi.on"},{value:e.referenceMemberCaption}):e.referenceMemberCaption]})]})]})]})},M=(e,t)=>{const l=[];return e&&t&&l.push({tuple:t,value:e.value}),{axes:[],cells:l}};var T=l(17323);function D(e,t){const{cells:l,numberOfColumns:n,numberOfRows:r}=(0,o.useMemo)((()=>{let t,l;for(let n=0;n<e.axes.length;n++){const r=e.axes[n];if(r.id===p.axisIds.columns?l=r:r.id===p.axisIds.rows&&(t=r),void 0!==t&&void 0!==l)break}const n=l?(0,i.getAxisLength)(l):1,r=t?(0,i.getAxisLength)(t):1,o=new Array(n*r).fill(null);return e.cells.forEach((e=>{o[e.ordinal]=e})),{numberOfColumns:n,numberOfRows:r,cells:o}}),[e]),a=(0,o.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e)),[e]);return{cells:l,numberOfColumns:n,numberOfRows:r,cube:(0,o.useMemo)((()=>{const l=e.cube;return(0,T.W)(t,l)}),[e,t]),hierarchyIndicesInCellSet:a}}const Y=["referenceCell","comparedCell","differenceCell"],N=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cube:l,hierarchyIndicesInCellSet:a,numberOfColumns:m,numberOfRows:h}=D(e.data,e.dataModel),y=e.data.axes.find((({id:e})=>e===p.axisIds.pages));if(!y)throw new Error("A comparison was defined in the KPI widget state, but no corresponding data was found (no PAGES axis in the cellset).");const g=y.positions.length,C=(0,c.D)(y.hierarchies[0].dimension,l),b=t({id:"aui.total"}),[v,S]=(0,o.useMemo)((()=>{const{dimension:t,hierarchy:n}=y.hierarchies[0],r=y.positions.map((([r])=>(0,u.t)({captionForTotals:b,cube:l,mapping:e.mapping,member:{dimensionName:t,hierarchyName:n,...r},style:e.style})));return 3===g?r:["N/A",r[0]]}),[b,l,g,y,e.mapping,e.style]),x=(0,o.useMemo)((()=>{const t={},n=m*h;return e.data.cells.forEach((r=>{const o=Math.floor(r.ordinal%n/m),s=r.ordinal%m,c=(0,i.getTuple)({columnIndex:s,rowIndex:o,hierarchyIndicesInCellSet:a,data:e.data});if(c){const o=(0,i.getTupleKey)(c),a=t[o]?.title||e.titles?.[o]||(0,d.V)({captionForTotals:b,cube:l,mapping:e.mapping,tuple:c,style:e.style}),s=Math.floor(r.ordinal/n),u=3===g?Y[s]:s===g-1?"differenceCell":"comparedCell";t[o]={...t[o],[u]:r,title:a,tuple:c}}}),{}),t}),[b,l,a,m,h,g,e.data,e.titles,e.mapping,e.style]),{titles:w,onTitlesChange:T,onSelectionChange:N}=e,O=({tupleKey:e,title:t})=>{T?.({...w,[e]:t})},[F,A]=(0,o.useState)({axes:[],cells:[]}),k=F.cells?.[0]?(0,i.getTupleKey)(F.cells[0].tuple):void 0,E=({cell:e,tuple:t,isSelected:l})=>{A(l?{axes:[],cells:[]}:M(e,t))};(0,o.useEffect)((()=>{N?.(F)}),[F,N]);const K=(0,r.map)(x,(({referenceCell:t,comparedCell:l,differenceCell:r,title:o,tuple:i},a)=>(0,n.Y)(I,{comparedCell:l,comparedMemberCaption:S,isTime:"TIME"===C.type,differenceCell:r,title:o,onTitleChange:O,referenceCell:t,referenceMemberCaption:v,tuple:i,onSelect:E,isSelected:k===a,style:e.style},a)));return(0,n.Y)(f,{numberOfColumns:m,containerStyle:e.containerStyle,children:K})};var O=l(92460),F=l(28673);const A=e=>{const t=(0,C.DP)(),{cell:l,tuple:r,tupleKey:i,onTitleChange:a,title:s,isSelected:c,onSelect:u,style:d}=e,p=(0,O.n)(l?.properties),f=c&&p.backgroundColor?(0,F.O)(p.backgroundColor,t.selectionOverlayColor,.2):c?t.selectionOverlayColor:p.backgroundColor??"none",[b,v]=(0,o.useMemo)((()=>{const e=r.find(h.t)?.namePath[0],t=e?d?.measures?.[e]:void 0;return[(0,y.m)({value:Number(l?.value),valueFormattedByAtotiServer:l?.formattedValue??"N/A",numericFieldStyle:t}),(0,g.T)({fieldStyle:t,value:l?.value})]}),[r,d?.measures,l]);return(0,n.FD)("div",{css:m.css`
        padding-left: 6px;
        border-left: 3px solid ${t.primaryColor};
        white-space: nowrap;
      `,children:[(0,n.Y)(S,{title:s,onTitleChange:e=>{a({title:e,tupleKey:i})}}),(0,n.Y)("div",{onMouseDown:e=>{(0===e.button||!c&&2===e.button)&&u({cell:l,tuple:r,isSelected:c})},css:{background:f,color:v.backgroundColor??p.color,fontSize:p.fontSize??30,height:50,display:"flex",alignItems:"center",paddingLeft:2,fontWeight:p.fontWeight,fontStyle:p.fontStyle,textDecoration:p.textDecoration},children:b})]})},k=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cells:l,numberOfColumns:r,cube:a,hierarchyIndicesInCellSet:c}=D(e.data,e.dataModel),{titles:u,onTitlesChange:p,onSelectionChange:m}=e,h=({tupleKey:e,title:t})=>{p?.({...u,[e]:t})},[y,g]=(0,o.useState)({axes:[],cells:[]}),C=y.cells?.[0]?(0,i.getTupleKey)(y.cells[0].tuple):void 0,b=({cell:e,tuple:t,isSelected:l})=>{g(l?{axes:[],cells:[]}:M(e,t))},v=t({id:"aui.total"}),S=(0,o.useMemo)((()=>{const t=[];return l.forEach(((l,n)=>{const o=Math.floor(n/r),s=n%r,p=(0,i.getTuple)({columnIndex:s,data:e.data,rowIndex:o,hierarchyIndicesInCellSet:c});if(p){const n=(0,i.getTupleKey)(p),r=a?(0,d.V)({captionForTotals:v,cube:a,mapping:e.mapping,tuple:p,style:e.style}):"",o=u?.[n]||r;t.push({cell:l,tuple:p,tupleKey:n,title:o})}})),t}),[l,a,e.data,c,r,u,v,e.mapping,e.style]);(0,o.useEffect)((()=>{m?.(y)}),[y,m]);const x=S.map((({cell:t,tuple:l,tupleKey:r,title:o},i)=>(0,n.Y)(A,{cell:t,cellIndex:i,tuple:l,tupleKey:r,title:o,onTitleChange:h,onSelect:b,isSelected:C===r,style:e.style},i)));return(0,n.Y)(f,{numberOfColumns:r,containerStyle:e.containerStyle,children:x})};var E=l(16361);const K=e=>{const{comparison:t,...l}=e;return(0,E.n)(e.comparison)?(0,n.Y)(N,{comparison:t,...l}):(0,n.Y)(k,{...l})};var P=l(834),L=l(67373),R=l(24730);const V=(0,o.memo)((e=>{(0,v.useCallOnLoadedAfterFirstProperRender)(e);const{queryResult:t,widgetState:l,onChange:s,onSelectionChange:c}=e,u=t.data,{serverKey:d}=(0,L.useCube)(l),p=(0,a.H)(d),m=l.titles,f=(0,o.useCallback)((e=>s((0,r.isEmpty)(e)?(0,r.omit)(l,"titles"):{...l,titles:e})),[l,s]);if(!t.isLoading&&t.error){if((0,i.isErrorInQueryResultOfType)(t.error,"QueryTimeoutException"))throw new i.QueryTimeoutError(t.error);throw new i.QueryError(t.error)}return!p||(0,P.isMappingEmpty)(l.mapping)?(0,n.Y)(R.Q,{style:e.style}):u&&0!==u.cells.length?(0,n.Y)(K,{data:u,dataModel:p,titles:m,onTitlesChange:f,comparison:l.comparison,containerStyle:e.style,onSelectionChange:c,style:l.style,mapping:l.mapping}):(0,n.Y)(R.Q,{style:e.style,reason:"noData",widgetState:l,onStateChange:s})})),B=(0,P.withLoadingOverlay)((0,P.withoutIrrelevantRenders)(V))}}]);