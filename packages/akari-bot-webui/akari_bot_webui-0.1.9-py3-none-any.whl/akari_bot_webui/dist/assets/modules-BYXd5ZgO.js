import{_ as D,c as w,o as h,e as n,w as a,a as o,z as T,d as m,t as u,E as S,J as P,n as z,aS as L,h as b,F as I,x as V,v as _,aU as y,L as i,u as R}from"./index-BKPS2Vtb.js";import{E as x}from"./card-Df2ItLck.js";import{E as K,a as U,b as N}from"./table-column-DjK45OOT.js";import{E as j}from"./select-Da1dgR_l.js";import{E as F}from"./col-CXcXusae.js";import{E as J}from"./index-BAyJ_jEh.js";import"./_initCloneObject-4T97wCKJ.js";import"./isPlainObject-8MKI3sch.js";import"./validator-B8-2NWUb.js";const O={name:"ModulesManager",data(){const{t:e}=R();return{modules:[],searchKeyword:"",loading:!1,showBaseModules:!1,currentPage:1,pageSize:10,debounceTimer:null,t:e}},computed:{filteredModules(){let e=this.modules;return this.searchKeyword&&(e=e.filter(s=>s.bind_prefix.toLowerCase().includes(this.searchKeyword.toLowerCase()))),this.showBaseModules||(e=e.filter(s=>!s.base)),e},pagedModules(){const e=(this.currentPage-1)*this.pageSize,s=e+this.pageSize;return this.filteredModules.slice(e,s)},totalModules(){return this.filteredModules.length}},mounted(){this.refreshData()},methods:{debouncedRefresh(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.refreshData(),300)},handleSizeChange(e){this.pageSize=e,this.currentPage=1},handleCurrentChange(e){this.currentPage=e},async refreshData(){this.loading=!0;try{const e=localStorage.getItem("language")||"zh_cn",s=await y.get("/api/modules",{params:{locale:e}});s.status===200&&s.data.modules&&(this.modules=Object.entries(s.data.modules).map(([l,d])=>{const r=d?._db_load!==!1;return{name:l,bind_prefix:d?.bind_prefix||l,desc:d?.desc||"",developers:d?.developers||[],loaded:r,base:d?.base===!0,...d}}).sort((l,d)=>l.name.localeCompare(d.name)))}catch(e){i.error(this.$t("message.error.fetch")+e.message)}finally{this.loading=!1}},async getRelatedModules(e){try{return(await y.get(`/api/module/${e}/related`)).data.modules||[]}catch{return i.error(this.$t("message.error.fetch")+error.message),[]}},async handleReload(e){let s="";if(e.base)s=this.t("modules.confirm.message.reload.base");else{const l=await this.getRelatedModules(e.name);l.length===0?s=this.t("modules.confirm.message.reload"):s=this.t("modules.confirm.message.reload.extra",{modules:l.map(d=>`"${d}"`).join("、")})}try{await J.confirm(s,this.t("confirm.warning"),{confirmButtonText:this.t("button.confirm"),cancelButtonText:this.t("button.cancel"),type:"warning"}),(await y.post(`/api/module/${e.name}/reload`)).status===204&&(i.success(this.t("modules.message.reload.success")),this.refreshData())}catch(l){if(l==="cancel"||l?.message==="cancel")return;l.response?.status===422?(i.error(this.t("modules.message.reload.error.failed")),this.refreshData()):i.error(this.$t("message.error.fetch")+l.message)}},async handleUnload(e){try{(await y.post(`/api/module/${e.name}/unload`)).status===204&&(i.success(this.t("modules.message.unload.success")),this.refreshData())}catch(s){s.response?.status===422?(i.error(this.t("modules.message.unload.error.failed")),this.refreshData()):i.error(this.$t("message.error.fetch")+s.message)}},async handleLoad(e){try{(await y.post(`/api/module/${e.name}/load`)).status===204&&(i.success(this.t("modules.message.load.success")),this.refreshData())}catch(s){s.response?.status===422?(i.error(this.t("modules.message.load.error.failed")),this.refreshData()):i.error(this.$t("message.error.fetch")+s.message)}}}},q={class:"header-container"},A={class:"filter-container"},G={class:"filter-item"},H={style:{"margin-bottom":"15px"}},Q={class:"pagination-wrapper"};function W(e,s,l,d,r,c){const p=S,v=P,M=F,g=K,C=j,k=U,E=N,$=x,B=L;return h(),w("div",null,[n($,{class:"module-card",shadow:"never"},{default:a(()=>[o("div",q,[o("h3",null,[s[3]||(s[3]=o("i",{class:"mdi mdi-puzzle"},null,-1)),m(" "+u(e.$t("modules.title")),1)]),n(p,{onClick:c.refreshData,type:"primary",size:"small",style:{float:"right","margin-left":"10px"}},{default:a(()=>[s[4]||(s[4]=o("i",{class:"mdi mdi-refresh"},null,-1)),m(" "+u(e.$t("data.button.refresh")),1)]),_:1},8,["onClick"])]),o("div",A,[n(M,{span:6},{default:a(()=>[o("div",G,[n(v,{modelValue:r.searchKeyword,"onUpdate:modelValue":s[0]||(s[0]=t=>r.searchKeyword=t),placeholder:e.$t("modules.input.module_name"),clearable:"",onInput:c.debouncedRefresh,"prefix-icon":e.Search},{prefix:a(()=>[...s[5]||(s[5]=[o("i",{class:"mdi mdi-magnify"},null,-1)])]),_:1},8,["modelValue","placeholder","onInput","prefix-icon"])])]),_:1})]),o("div",H,[n(p,{type:"info",size:"small",onClick:s[1]||(s[1]=t=>r.showBaseModules=!r.showBaseModules)},{default:a(()=>[o("i",{class:z(r.showBaseModules?"mdi mdi-eye-off-outline":"mdi mdi-eye-outline")},null,2),m(" "+u(r.showBaseModules?e.$t("modules.button.hide_base"):e.$t("modules.button.show_base")),1)]),_:1})]),T((h(),b(k,{data:c.pagedModules,style:{width:"100%"},stripe:""},{default:a(()=>[n(g,{label:e.$t("modules.table.name"),"min-width":"140"},{default:a(({row:t})=>[o("span",{class:z({unloaded:!t.loaded})},u(t.bind_prefix),3)]),_:1},8,["label"]),n(g,{label:e.$t("modules.table.desc"),"min-width":"800"},{default:a(({row:t})=>[m(u(t.desc||"-"),1)]),_:1},8,["label"]),n(g,{label:e.$t("modules.table.developers"),"min-width":"400"},{default:a(({row:t})=>[(h(!0),w(I,null,V(t.developers,f=>(h(),b(C,{key:f,type:"info",style:{margin:"2px"}},{default:a(()=>[m(u(f),1)]),_:2},1024))),128))]),_:1},8,["label"]),n(g,{label:e.$t("data.table.status"),"min-width":"100"},{default:a(({row:t})=>[n(C,{type:t.base?"warning":t.loaded?"success":"danger"},{default:a(()=>[m(u(t.base?e.$t("modules.tag.base"):t.loaded?e.$t("modules.tag.loaded"):e.$t("modules.tag.unloaded")),1)]),_:2},1032,["type"])]),_:1},8,["label"]),n(g,{label:e.$t("data.table.operation"),"min-width":"240"},{default:a(({row:t})=>[n(p,{size:"small",type:"warning",onClick:f=>c.handleReload(t)},{default:a(()=>[s[6]||(s[6]=o("i",{class:"mdi mdi-reload"},null,-1)),m(" "+u(e.$t("modules.button.reload")),1)]),_:1},8,["onClick"]),!t.base&&t.loaded?(h(),b(p,{key:0,size:"small",type:"danger",onClick:f=>c.handleUnload(t)},{default:a(()=>[s[7]||(s[7]=o("i",{class:"mdi mdi-puzzle-remove"},null,-1)),m(" "+u(e.$t("modules.button.unload")),1)]),_:1},8,["onClick"])):_("",!0),!t.base&&!t.loaded?(h(),b(p,{key:1,size:"small",type:"success",onClick:f=>c.handleLoad(t)},{default:a(()=>[s[8]||(s[8]=o("i",{class:"mdi mdi-puzzle-plus"},null,-1)),m(" "+u(e.$t("modules.button.load")),1)]),_:1},8,["onClick"])):_("",!0)]),_:1},8,["label"])]),_:1},8,["data"])),[[B,r.loading]]),o("div",Q,[c.totalModules>0?(h(),b(E,{key:0,background:"",layout:"prev, pager, next","current-page":r.currentPage,"onUpdate:currentPage":s[2]||(s[2]=t=>r.currentPage=t),"page-size":r.pageSize,total:c.totalModules,style:{"margin-top":"20px"},onCurrentChange:e.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])):_("",!0)])]),_:1})])}const re=D(O,[["render",W],["__scopeId","data-v-9c361acc"]]);export{re as default};
