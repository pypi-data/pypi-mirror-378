---
# Apoxy Backend for general deployment
apiVersion: core.apoxy.dev/v1alpha
kind: Backend
metadata:
  name: {{ unique_cluster_name }}-backend-{{ deployment_number }}
  labels:
    task_name: {{ name }}
    endpoint_name: {{ cluster_name }}-{{ deployment_number }}.trainy.us
spec:
  endpoints:
    - fqdn: {{ name }}.default.{{ unique_cluster_name }}.tun.apoxy.net
---
# Apoxy Route for general deployment
apiVersion: gateway.apoxy.dev/v1
kind: HTTPRoute
metadata:
  name: {{ unique_cluster_name }}-route-{{ deployment_number }}
  labels:
    task_name: {{ name }}
    endpoint_name: {{ cluster_name }}-{{ deployment_number }}.trainy.us
spec:
  parentRefs:
    - name: default 
      kind: Gateway
      port: 443
  hostnames:
    - '{{ cluster_name }}-{{ deployment_number }}.trainy.us'
  rules:
    - backendRefs:
        - kind: Backend
          name: {{ unique_cluster_name }}-backend-{{ deployment_number }}
          port: {{ ports }}