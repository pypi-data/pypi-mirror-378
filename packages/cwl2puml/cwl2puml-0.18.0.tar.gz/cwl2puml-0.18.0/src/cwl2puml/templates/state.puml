/'
 ' Diagram generated by cwl2puml v{{ version }}
 ' timestamp: {{ timestamp }}
 '/
@startuml
hide empty description

{% macro serialize_workflow(workflow) -%}
    {% for step in workflow.steps %}
        {% set wf_guard = namespace(found=false) %}

        {% for process in workflows %}
            {% if process.id in step.run and 'Workflow' == process.class_ %}
                {% set wf_guard.found = true %}
' Workflow
state "{{ workflow.id }}" as {{ workflow.id | to_puml_name }} {
                {% for input in process.inputs %}
    state "{{ input.id }}" as {{ process.id | to_puml_name }}_{{ input.id | to_puml_name }} <<entryPoint>>
                {% endfor %}
                {% for input in step.in_  %}
    {% if '/' not in input.source %}{{ workflow.id | to_puml_name }}_{% endif %}{{ input.source | to_puml_name }} --> {{ process.id | to_puml_name }}_{{ input.id | to_puml_name }}
                {% endfor %}

                {{ serialize_workflow(process) }}

                {% for output in process.outputs %}
    state "{{ output.id }}" as {{ step.id | to_puml_name }}_{{ output.id | to_puml_name }} <<exitPoint>>
    {{ output.outputSource[0] | to_puml_name }} --> {{ step.id | to_puml_name }}_{{ output.id | to_puml_name }}
                {% endfor %}
}
            {% endif %}
        {% endfor %}

        {% if not wf_guard.found %}
    state {{ step.id | to_puml_name }} {
            {% for input in step.in_  %}
        state "{{ input.id }}" as {{ step.id | to_puml_name }}_{{ input.id | to_puml_name }} <<entryPoint>>
        {% if '/' not in input.source %}{{ workflow.id | to_puml_name }}_{% endif %}{{ input.source | to_puml_name }} --> {{ step.id | to_puml_name }}_{{ input.id | to_puml_name }}
            {% endfor %}

            {% for output in step.out  %}
        state "{{ output }}" as {{ step.id | to_puml_name }}_{{ output | to_puml_name }} <<exitPoint>>
            {% endfor %}
    }
        {% endif %}
    {% endfor %}
{%- endmacro %}

{% for process in workflows %}
    {% if 'Workflow' == process.class_ and workflow_id == process.id %}
state "{{ process.id }}" as {{ process.id | to_puml_name }} {
        {% for input in process.inputs %}
    state "{{ input.id }}" as {{ process.id | to_puml_name }}_{{ input.id | to_puml_name }} <<entryPoint>>
        {% endfor %}

{{ serialize_workflow(process) }}

            {% for output in process.outputs %}
state "{{ output.id }}" as {{ process.id | to_puml_name }}_{{ output.id | to_puml_name }} <<exitPoint>>
{{ output.outputSource[0] | to_puml_name }} --> {{ process.id | to_puml_name }}_{{ output.id | to_puml_name }}
            {% endfor %}
}
        {% for input in process.inputs %}
[*] --> {{ process.id | to_puml_name }}_{{ input.id | to_puml_name }}
        {% endfor %}

        {% for output in process.outputs %}
{{ process.id | to_puml_name }}_{{ output.id | to_puml_name }} --> [*]
        {% endfor %}
    {% endif %}
{% endfor %}

@enduml
