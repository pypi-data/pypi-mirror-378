"""
Yardee Python SDK - Quickstart Example

This example demonstrates core functionality of the Yardee Python SDK.
Replace 'your-api-key-here' with your actual API key from app.yardee.ai
"""

import os
from yardee import Client, YardeeError

def main():
    # Initialize the client
    api_key = os.getenv("YARDEE_API_KEY", "sk-your-api-key-here")
    
    if api_key == "sk-your-api-key-here":
        print("âš ï¸  Please set your API key!")
        print("   Option 1: Set environment variable: export YARDEE_API_KEY=sk-your-key")
        print("   Option 2: Replace 'sk-your-api-key-here' in this file")
        print("   Get your API key at: https://app.yardee.ai")
        return
    
    # Create client
    client = Client(api_key=api_key)
    print("ğŸš€ Yardee SDK Quickstart Example")
    print("=" * 50)
    
    try:
        # 1. List existing knowledge bases
        print("\nğŸ“š Your Knowledge Bases:")
        kb_list = client.list_knowledge_bases()
        
        if kb_list['count'] == 0:
            print("   No knowledge bases found. Let's create one!")
            
            # Create a new knowledge base
            new_kb = client.create_knowledge_base(
                name="SDK Test KB",
                description="Test knowledge base created by Python SDK"
            )
            print(f"âœ… Created knowledge base: {new_kb['name']} (ID: {new_kb['id']})")
            kb_id = new_kb['id']
            
        else:
            # Use the first existing knowledge base
            kb = kb_list['knowledge_bases'][0]
            kb_id = kb['id']
            print(f"ğŸ“– Using existing KB: {kb['name']} (ID: {kb_id})")
            
            # Show all knowledge bases
            for kb in kb_list['knowledge_bases']:
                print(f"   - {kb['name']} (ID: {kb['id']}) - {kb.get('document_count', 0)} documents")
        
        # 2. List documents in the knowledge base
        print(f"\nğŸ“„ Documents in Knowledge Base {kb_id}:")
        documents = client.list_documents(kb_id)
        
        if documents['count'] == 0:
            print("   No documents found in this knowledge base.")
            print("   ğŸ’¡ Upload some documents to enable search functionality!")
        else:
            for doc in documents['documents']:
                print(f"   - {doc['filename']} (ID: {doc['id']}) - {doc.get('chunk_count', 0)} chunks")
        
        # 3. Perform a search (even if no documents - will show empty results)
        print(f"\nğŸ” Testing Search Functionality:")
        
        test_queries = [
            "How do I get started?",
            "What are the pricing plans?", 
            "API documentation",
            "customer support contact"
        ]
        
        for query in test_queries[:2]:  # Test first 2 queries
            print(f"\n   Query: '{query}'")
            
            try:
                results = client.search(
                    knowledge_base_id=kb_id,
                    query=query,
                    top_k=3,
                    similarity_threshold=0.1
                )
                
                if results['results']:
                    print(f"   âœ… Found {len(results['results'])} results:")
                    for i, result in enumerate(results['results'], 1):
                        score = result.get('similarity_score', 'N/A')
                        content_preview = result['content'][:100] + "..." if len(result['content']) > 100 else result['content']
                        print(f"      {i}. Score: {score}")
                        print(f"         Preview: {content_preview}")
                        
                        # Show metadata if available
                        if 'metadata' in result and result['metadata']:
                            metadata = result['metadata']
                            if isinstance(metadata, dict):
                                for key, value in list(metadata.items())[:2]:  # Show first 2 metadata fields
                                    print(f"         {key}: {value}")
                else:
                    print("   ğŸ“­ No results found (knowledge base may be empty)")
                    
            except YardeeError as e:
                print(f"   âŒ Search error: {e}")
        
        # 4. Test connection features (if available)
        print(f"\nğŸ”— Testing Connection Features:")
        try:
            connections = client.list_connections(kb_id)
            print(f"   ğŸ“Š Found {len(connections.get('connections', []))} existing connections")
            
            # Show connection types
            for conn in connections.get('connections', [])[:3]:  # Show first 3
                conn_type = conn.get('db_type', 'unknown')
                status = conn.get('status', 'unknown')
                print(f"   - {conn['name']} ({conn_type}) - {status}")
            
            if not connections.get('connections'):
                print("   ğŸ’¡ No connections found. You can add:")
                print("      â€¢ PostgreSQL/MySQL databases for live data queries")
                print("      â€¢ HubSpot CRM for customer data access")
                print("      â€¢ All queryable through the same search endpoint!")
            
        except YardeeError as e:
            print(f"   ğŸ“ Connection info: {e}")
        
        # 5. Advanced search example (with metadata filters)
        print(f"\nğŸ¯ Advanced Search with Filters:")
        try:
            advanced_results = client.search(
                knowledge_base_id=kb_id,
                query="documentation",
                top_k=5,
                similarity_threshold=0.1,
                use_mmr=True,  # Maximum Marginal Relevance for diverse results
                metadata_filters={"type": "guide"}  # Example filter
            )
            
            print(f"   âœ… Advanced search completed")
            print(f"   ğŸ“Š Results: {len(advanced_results['results'])}")
            print(f"   ğŸ›ï¸  Used MMR for result diversity")
            
        except YardeeError as e:
            print(f"   âš ï¸  Advanced search note: {e}")
        
        # 6. Show SDK capabilities
        print(f"\nğŸ›  SDK Capabilities Demonstrated:")
        print("   âœ… Client initialization with API key")
        print("   âœ… Knowledge base listing and creation")  
        print("   âœ… Document management")
        print("   âœ… Basic semantic search")
        print("   âœ… Connection management (DB + HubSpot)")
        print("   âœ… Advanced search with filters")
        print("   âœ… Error handling")
        
        print(f"\nğŸ‰ Quickstart Complete!")
        print("   Next steps:")
        print("   1. Upload documents to your knowledge base")
        print("   2. Connect databases or HubSpot for live data")
        print("   3. Try different search queries")
        print("   4. Integrate into your application")
        print("   5. Check out the full documentation")
        
        # Get KB details
        kb_details = client.get_knowledge_base(kb_id)
        print(f"\nğŸ“Š Knowledge Base Details:")
        print(f"   Name: {kb_details['name']}")
        print(f"   Description: {kb_details.get('description', 'No description')}")
        print(f"   Documents: {kb_details.get('document_count', 0)}")
        print(f"   Created: {kb_details.get('created_at', 'Unknown')}")
        
    except YardeeError as e:
        print(f"âŒ Yardee API Error: {e}")
        print("   Check your API key and network connection")
        
    except Exception as e:
        print(f"ğŸ’¥ Unexpected Error: {e}")
        print("   Please check the error details and try again")
        
    finally:
        # Clean up
        client.close()
        print("\nğŸ”’ Connection closed")


# Helper function for connection demos
def demo_database_connection(client, kb_id):
    """
    Example function to create a database connection.
    
    Args:
        client: Yardee client instance
        kb_id: Knowledge base ID
    """
    try:
        print("ğŸ“Š Creating PostgreSQL connection demo...")
        
        db_conn = client.create_database_connection(
            knowledge_base_id=kb_id,
            name="Demo PostgreSQL",
            db_type="postgres",
            host="demo.postgres.com",
            port=5432,
            database="demo_db",
            username="demo_user",
            password="demo_password"
        )
        
        print(f"âœ… Database connection created! ID: {db_conn['id']}")
        
        # Test the connection
        test_result = client.test_connection(kb_id, db_conn['id'])
        if test_result['success']:
            print("âœ… Connection test passed!")
        else:
            print(f"âš ï¸  Connection test failed: {test_result.get('error', 'Unknown error')}")
        
        return db_conn
        
    except Exception as e:
        print(f"âŒ Database connection demo failed: {e}")
        return None


def demo_hubspot_connection(client, kb_id):
    """
    Example function to create a HubSpot connection.
    
    Args:
        client: Yardee client instance
        kb_id: Knowledge base ID
    """
    try:
        hubspot_token = os.getenv("HUBSPOT_PRIVATE_APP_TOKEN")
        
        if not hubspot_token:
            print("âš ï¸  No HUBSPOT_PRIVATE_APP_TOKEN environment variable found")
            print("   Get your token from HubSpot Settings â†’ Integrations â†’ Private Apps")
            return None
        
        print("ğŸš€ Creating HubSpot connection...")
        
        hubspot_conn = client.create_hubspot_connection(
            knowledge_base_id=kb_id,
            name="Demo HubSpot CRM",
            private_app_token=hubspot_token
        )
        
        print(f"âœ… HubSpot connection created! ID: {hubspot_conn['id']}")
        
        # Test the connection
        test_result = client.test_connection(kb_id, hubspot_conn['id'])
        if test_result['success']:
            print("âœ… HubSpot connection test passed!")
        else:
            print(f"âš ï¸  HubSpot test failed: {test_result.get('error', 'Unknown error')}")
        
        return hubspot_conn
        
    except Exception as e:
        print(f"âŒ HubSpot connection demo failed: {e}")
        return None


if __name__ == "__main__":
    print("Yardee Python SDK - Quickstart Example")
    print("Get your API key at: https://app.yardee.ai")
    print()
    
    main()