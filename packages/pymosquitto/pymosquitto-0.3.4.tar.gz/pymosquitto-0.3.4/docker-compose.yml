x-template: &base
  build: .
  volumes:
    - .:/app
  working_dir: /app
  init: true
  network_mode: service:broker
  environment:
    MQTT_QOS: ${MQTT_QOS:-0}
    MQTT_LIMIT: ${MQTT_LIMIT:-1000}
    PUB_INTERVAL: ${PUB_INTERVAL:-1000}
    FLESPI_TOKEN: ${FLESPI_TOKEN:-""}

services:
  py:
    <<: *base
    volumes:
      - .:/app
      - ~/.pypirc:/root/.pypirc:ro
    network_mode: bridge
    command: /usr/bin/time -v python3 -c ""

  broker:
    image: eclipse-mosquitto:latest
    init: true

  pub:
    image: emqx/emqtt-bench:latest
    network_mode: service:broker
    init: true
    depends_on:
      - broker
    command: pub -c 8 -I ${PUB_INTERVAL:-1000} -t benchmark -s 0

  sub:
    <<: *base
    depends_on:
      - broker
      - pub
    command: sh -c "sleep 1 && /usr/bin/time -v python3 -m benchmarks.${MODULE:-pymosq}_sub"
#    command: sh -c "sleep 1 && /usr/bin/time -v py-spy record -o profile.svg -- python3 -m benchmarks.${MODULE:-pymosq}_sub"
