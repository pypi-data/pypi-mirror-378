name: Upload Python Package to PyPI when a Release is Created

on:
  release:
    types: [created]
  push:
    branches:
      - master

jobs:
  build-linux:
    name: Build wheels on Linux (manylinux_2_28, x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python (runner tool for cibuildwheel)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel

      - name: Build wheels with cibuildwheel
        env:
          CIBW_BUILD: 'cp311-* cp312-* cp313-*'
          CIBW_ARCHS_LINUX: 'x86_64'
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          # Prep toolchain & vcpkg (classic mode) INSIDE the manylinux container
          CIBW_BEFORE_ALL_LINUX: |
            yum -y install git curl zip unzip tar which pkgconfig gcc gcc-c++ gcc-gfortran make
            git clone https://github.com/microsoft/vcpkg /opt/vcpkg
            /opt/vcpkg/bootstrap-vcpkg.sh -disableMetrics
            # /opt/vcpkg/vcpkg install --classic --triplet x64-linux suitesparse-cholmod lapack
          # Make CMake see vcpkg, but DISABLE manifest mode
          CIBW_ENVIRONMENT_LINUX: 'VCPKG_ROOT=/opt/vcpkg' # VCPKG_MANIFEST_MODE=OFF'
        run: |
          cibuildwheel --output-dir dist

      - name: Upload Linux wheels
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: dist

  build-macos:
    name: Build wheels on macOS (x86_64 + arm64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python (runner tool for cibuildwheel)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel

      - name: Build wheels with cibuildwheel
        env:
          CIBW_BUILD: 'cp311-* cp312-* cp313-*'
          CIBW_ARCHS_MACOS: 'x86_64 arm64'
          CIBW_BEFORE_ALL_MACOS: |
            brew update
            brew install gcc
            git clone https://github.com/microsoft/vcpkg "$HOME/vcpkg"
            "$HOME/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
            # "$HOME/vcpkg/vcpkg" install --classic suitesparse-cholmod lapack
          # Point CMake at vcpkg and turn OFF manifest mode
          CIBW_ENVIRONMENT_MACOS: 'VCPKG_ROOT=$HOME/vcpkg' # VCPKG_MANIFEST_MODE=OFF'
        run: |
          cibuildwheel --output-dir dist

      - name: Upload macOS wheels
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: dist

  build-sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build sdist
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build --sdist --outdir dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: dist-sdist
          path: dist/*.tar.gz

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-sdist]
    environment:
      name: pypi
    permissions:
      id-token: write
    steps:
      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: dist-linux
          path: dist

      - name: Download macOS wheels
        uses: actions/download-artifact@v4
        with:
          name: dist-macos
          path: dist

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: dist-sdist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
