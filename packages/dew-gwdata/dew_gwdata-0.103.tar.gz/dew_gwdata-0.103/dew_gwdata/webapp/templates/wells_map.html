{% extends "app_layout_wells.html" %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.0/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.0/leaflet.js"></script>

<link rel="stylesheet" href="/static/MarkerCluster.css" />
<link rel="stylesheet" href="/static/MarkerCluster.Default.css" />
<script src="/static/leaflet.markercluster-src.js"></script>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-tilelayer-geojson/1.0.4/TileLayer.GeoJSON.min.js" ></script> -->

<script src="/{{__version__}}/static/leaflet.ajax.min.js"></script>
{% endblock %}

{% block header_title %}
{{ title }} - Map
{% endblock %}

{% block title %}
Map - {{ title }}
{% endblock %}

{% block wells_content %}

    <div id="map"></div>

<script>
    $(document).ready(function () {

        var openTopoAttr = 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)';
        var esriImageryAttr = 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';

        var openTopoBase = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: openTopoAttr
        });
        var esriImageryBase = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: esriImageryAttr
        });
        var tileUrlParams = '/wells/tiles/?zoom={z}&tilex={x}&tiley={y}';
        var geojsonUrlParams = '/wells/geojson/?'
        {% for key, value in kwargs %}
        tileUrlParams += '&{{key}}={{value}}';
        geojsonUrlParams += '&{{key}}={{value}}';
        {% endfor %}
        options = {
            // pointToLayer: function (feature, latlng) {                    
            //            return new L.CircleMarker(latlng, {
            //                radius: 6,
            //                fillColor: "cyan",
            //                color: "#000",
            //                weight: 0.8,
            //                opacity: 1,
            //                fillOpacity: 0.5
            //            });
            //        },
            onEachFeature: function (feature, layer) {
                if (feature.properties) {
                    var popupString = '<div class="popup">';
                    for (var k in feature.properties) {
                        var v = feature.properties[k];
                        popupString += k + ': ' + v + '<br />';
                    }
                    popupString += '</div>';
                    layer.bindPopup(popupString);
                }
            },
        };
        // var wellsGeojsonLayer = new L.TileLayer.GeoJSON(tileUrlParams, {}, options);
        var geojsonLinks = {{ ajax_links_js| safe
    }};
    var wellsLayer = new L.GeoJSON.AJAX(geojsonLinks, options);
    var wellsClustered = new L.markerClusterGroup();
    wellsClustered.addLayer(wellsLayer);

    var map = L.map('map', {
        center: [{{ center_lat }}, {{ center_lon }}],
        zoom: {{ zoom }},
        layers: [openTopoBase, wellsLayer]
    });

    $("#map").height($(window).height() * 0.8).width($(window).width() * 0.95);
    map.invalidateSize();

    var baseMaps = {
        "Imagery": esriImageryBase,
        "Topographic": openTopoBase
    };
    var overlayMaps = {
        // "{{fwells|length}} queried wells": wellsGeojsonLayer,
        "{{fwells|length}} paged wells": wellsLayer
    };

    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
    L.control.scale().addTo(map);
});
</script>

{% endblock %}