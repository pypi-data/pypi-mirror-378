"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[9997],{19997:(e,t,n)=>{n.r(t),n.d(t,{default:()=>$});var a=n(96540),o=n(58561),i=n.n(o),l=n(5556),s=n.n(l),r=n(38134),h=n(49965),u=n(82472),d=n(88217),c=n(50290),p=n(74098),m=n(79378),y=n(18749),v=n(65432),A=n(7741),b=n(77709),g=n(88396),f=n(96548),C=n(98837),T=n(61632),S=n(88843),w=n(3513),E=n(65853),_=n(18865);function L(e){return Object.keys(e).reduce(((e,t)=>{const n=e;return n[t]=t,n}),{})}const F={FORMULA:{value:"FORMULA",label:(0,p.t)("Formula")},EVENT:{value:"EVENT",label:(0,p.t)("Event"),supportNativeSource:!0},INTERVAL:{value:"INTERVAL",label:(0,p.t)("Interval"),supportNativeSource:!0},TIME_SERIES:{value:"TIME_SERIES",label:(0,p.t)("Time series")}},N=L(F),V=N.FORMULA,Y={NATIVE:{value:"NATIVE",label:"Superset annotation"}},I=L(Y);function D(e){return!!e}var k=n(2445);const M="",R={name:s().string,annotationType:s().string,sourceType:s().string,color:s().string,opacity:s().string,style:s().string,width:s().number,showMarkers:s().bool,hideLine:s().bool,value:s().oneOfType([s().string,s().number]),overrides:s().object,show:s().bool,showLabel:s().bool,titleColumn:s().string,descriptionColumns:s().arrayOf(s().string),timeColumn:s().string,intervalEndColumn:s().string,vizType:s().string,error:s().string,colorScheme:s().string,addAnnotationLayer:s().func,removeAnnotationLayer:s().func,close:s().func},x={name:"",annotationType:V,sourceType:"",color:M,opacity:"",style:"solid",width:1,showMarkers:!1,hideLine:!1,overrides:{},colorScheme:"d3Category10",show:!0,showLabel:!1,titleColumn:"",descriptionColumns:[],timeColumn:"",intervalEndColumn:"",addAnnotationLayer:()=>{},removeAnnotationLayer:()=>{},close:()=>{}},z=c.I4.div`
  && > div:first-child {
    padding-left: 0;
    padding-right: 0;
  }
`,O=()=>(0,k.Y)(z,{children:(0,k.Y)(r.p,{title:(0,p.t)("No annotation layers"),size:"small",description:(0,k.FD)("span",{children:[(0,p.t)("Add an annotation layer")," ",(0,k.Y)("a",{href:"/annotationlayer/list",target:"_blank",rel:"noopener noreferrer",children:(0,p.t)("here")}),"."]}),image:"empty.svg"})});class U extends a.PureComponent{constructor(e){super(e),this.fetchNativeAnnotations=async(e,t,n)=>{const a=i().encode({filters:[{col:"name",opr:"ct",value:e}],columns:["id","name"],page:t,page_size:n}),{json:o}=await m.A.get({endpoint:`/api/v1/annotation_layer/?q=${a}`}),{result:l,count:s}=o;return{data:l.map((e=>({value:e.id,label:e.name}))),totalCount:s}},this.fetchCharts=async(e,t,n)=>{const{annotationType:a}=this.state,o=i().encode({filters:[{col:"slice_name",opr:"chart_all_text",value:e},{col:"id",opr:"chart_owned_created_favored_by_me",value:!0}],columns:["id","slice_name","viz_type"],order_column:"slice_name",order_direction:"asc",page:t,page_size:n}),{json:l}=await m.A.get({endpoint:`/api/v1/chart/?q=${o}`}),{result:s,count:r}=l,h=(0,y.A)();return{data:s.filter((e=>{const t=h.get(e.viz_type);return t&&t.canBeAnnotationType(a)})).map((e=>({value:e.id,label:e.slice_name,viz_type:e.viz_type}))),totalCount:r}},this.fetchOptions=(e,t,n)=>{const{sourceType:a}=this.state;return a===I.NATIVE?this.fetchNativeAnnotations(e,t,n):this.fetchCharts(e,t,n)},this.fetchSliceData=e=>{const t=i().encode({columns:["query_context"]});m.A.get({endpoint:`/api/v1/chart/${e}?q=${t}`}).then((({json:e})=>{var t;const{result:n}=e,a=n.query_context,o=JSON.parse(a).form_data,i={data:{...o,groupby:null==(t=o.groupby)?void 0:t.map((e=>(0,v.A)(e)))}};this.setState({slice:i})}))};const{name:t,annotationType:n,sourceType:a,color:o,opacity:l,style:s,width:r,showMarkers:h,hideLine:u,value:d,overrides:c,show:p,showLabel:A,titleColumn:b,descriptionColumns:g,timeColumn:f,intervalEndColumn:C,vizType:T}=e;("since"in c||"until"in c)&&(c.time_range=null,delete c.since,delete c.until);const S=(0,y.A)().get(T),w=(null==S?void 0:S.supportedAnnotationTypes)||[],E=w.includes(n)?n:w[0];this.state={name:t,annotationType:E,sourceType:a,value:d,overrides:c,show:p,showLabel:A,titleColumn:b,descriptionColumns:g,timeColumn:f,intervalEndColumn:C,color:o||M,opacity:l,style:s,width:r,showMarkers:h,hideLine:u,isNew:!t,slice:null},this.submitAnnotation=this.submitAnnotation.bind(this),this.deleteAnnotation=this.deleteAnnotation.bind(this),this.applyAnnotation=this.applyAnnotation.bind(this),this.isValidForm=this.isValidForm.bind(this),this.handleAnnotationType=this.handleAnnotationType.bind(this),this.handleAnnotationSourceType=this.handleAnnotationSourceType.bind(this),this.handleSelectValue=this.handleSelectValue.bind(this),this.handleTextValue=this.handleTextValue.bind(this),this.fetchOptions=this.fetchOptions.bind(this),this.fetchCharts=this.fetchCharts.bind(this),this.fetchNativeAnnotations=this.fetchNativeAnnotations.bind(this),this.fetchAppliedAnnotation=this.fetchAppliedAnnotation.bind(this),this.fetchSliceData=this.fetchSliceData.bind(this),this.shouldFetchSliceData=this.shouldFetchSliceData.bind(this),this.fetchAppliedChart=this.fetchAppliedChart.bind(this),this.fetchAppliedNativeAnnotation=this.fetchAppliedNativeAnnotation.bind(this),this.shouldFetchAppliedAnnotation=this.shouldFetchAppliedAnnotation.bind(this)}componentDidMount(){if(this.shouldFetchAppliedAnnotation()){const{value:e}=this.state;this.fetchAppliedAnnotation(e)}}componentDidUpdate(e,t){if(this.shouldFetchSliceData(t)){const{value:e}=this.state;this.fetchSliceData(e.value)}}getSupportedSourceTypes(e){var t;const n=(0,y.A)().entries().filter((({value:t})=>t.canBeAnnotationType(e))).map((({key:e,value:t})=>({value:e===A.Y.Line?"line":e,label:t.name})));return null!=(t=F[e])&&t.supportNativeSource&&n.unshift(Y.NATIVE),n}shouldFetchAppliedAnnotation(){const{value:e,sourceType:t}=this.state;return e&&D(t)}shouldFetchSliceData(e){const{value:t,sourceType:n}=this.state,a=n!==I.NATIVE&&D(n);return t&&e.value!==t&&a}isValidFormulaAnnotation(e,t){return t!==N.FORMULA||(0,b.$)(e)}isValidForm(){const{name:e,annotationType:t,sourceType:n,value:a,timeColumn:o,intervalEndColumn:i}=this.state,l=[(0,g.A)(e),(0,g.A)(t),(0,g.A)(a)];return n!==I.NATIVE&&(t===N.EVENT&&l.push((0,g.A)(o)),t===N.INTERVAL&&(l.push((0,g.A)(o)),l.push((0,g.A)(i)))),l.push(!this.isValidFormulaAnnotation(a,t)),!l.filter((e=>e)).length}handleAnnotationType(e){this.setState({annotationType:e,sourceType:null,value:null,slice:null})}handleAnnotationSourceType(e){const{sourceType:t}=this.state;t!==e&&this.setState({sourceType:e,value:null,slice:null})}handleSelectValue(e){this.setState({value:e,descriptionColumns:[],intervalEndColumn:null,timeColumn:null,titleColumn:null,overrides:{time_range:null}})}handleTextValue(e){this.setState({value:e})}fetchAppliedChart(e){const{annotationType:t}=this.state,n=(0,y.A)(),a=i().encode({columns:["slice_name","query_context","viz_type"]});m.A.get({endpoint:`/api/v1/chart/${e}?q=${a}`}).then((({json:a})=>{const{result:o}=a,i=o.slice_name,l=o.query_context,s=o.viz_type,r=JSON.parse(l).form_data,h=n.get(s);var u;h&&h.canBeAnnotationType(t)&&this.setState({value:{value:e,label:i},slice:{data:{...r,groupby:null==(u=r.groupby)?void 0:u.map((e=>(0,v.A)(e)))}}})}))}fetchAppliedNativeAnnotation(e){m.A.get({endpoint:`/api/v1/annotation_layer/${e}`}).then((({json:e})=>{const{result:t}=e,n=t;this.setState({value:{value:n.id,label:n.name}})}))}fetchAppliedAnnotation(e){const{sourceType:t}=this.state;return t===I.NATIVE?this.fetchAppliedNativeAnnotation(e):this.fetchAppliedChart(e)}deleteAnnotation(){this.props.removeAnnotationLayer(),this.props.close()}applyAnnotation(){const{value:e,sourceType:t}=this.state;if(this.isValidForm()){const n={};["name","annotationType","sourceType","color","opacity","style","width","showMarkers","hideLine","overrides","show","showLabel","titleColumn","descriptionColumns","timeColumn","intervalEndColumn"].forEach((e=>{null!==this.state[e]&&(n[e]=this.state[e])}));const a=D(t)?e.value:e;n.value=a,n.color===M&&(n.color=null),this.props.addAnnotationLayer(n),this.setState({isNew:!1})}}submitAnnotation(){this.applyAnnotation(),this.props.close()}renderChartHeader(e,t,n){return(0,k.Y)(_.A,{hovered:!0,label:e,description:t,validationErrors:n?[]:["Mandatory"]})}renderValueConfiguration(){const{annotationType:e,sourceType:t,value:n}=this.state;let a="",o="";return D(t)?t===I.NATIVE?(a=(0,p.t)("Annotation layer"),o=(0,p.t)("Select the Annotation Layer you would like to use.")):(a=(0,p.t)("Chart"),o=(0,p.t)("Use another existing chart as a source for annotations and overlays.\n          Your chart must be one of these visualization types: [%s]",this.getSupportedSourceTypes(e).map((e=>e.label)).join(", "))):e===N.FORMULA&&(a=(0,p.t)("Formula"),o=(0,p.t)("Expects a formula with depending time parameter 'x'\n        in milliseconds since epoch. mathjs is used to evaluate the formulas.\n        Example: '2x+5'")),D(t)?(0,k.Y)(h.A,{ariaLabel:(0,p.t)("Annotation layer value"),name:"annotation-layer-value",header:this.renderChartHeader(a,o,n),options:this.fetchOptions,value:n||null,onChange:this.handleSelectValue,notFoundContent:(0,k.Y)(O,{})},t):e===N.FORMULA?(0,k.Y)(S.A,{name:"annotation-layer-value",hovered:!0,showHeader:!0,description:o,label:a,placeholder:"",value:n,onChange:this.handleTextValue,validationErrors:this.isValidFormulaAnnotation(n,e)?[]:[(0,p.t)("Bad formula.")]}):""}renderSliceConfiguration(){const{annotationType:e,sourceType:t,value:n,slice:a,overrides:o,titleColumn:i,timeColumn:l,intervalEndColumn:s,descriptionColumns:r}=this.state;if(!a||!n)return"";if(t!==I.NATIVE&&a){const t=(a.data.groupby||[]).concat(a.data.all_columns||[]).map((e=>({value:e,label:e}))),n=a.data.include_time?[{value:"__timestamp",label:"__timestamp"}].concat(t):t;return(0,k.Y)("div",{style:{marginRight:"2rem"},children:(0,k.FD)(E.A,{isSelected:!0,title:(0,p.t)("Annotation Slice Configuration"),info:(0,p.t)("This section allows you to configure how to use the slice\n              to generate annotations."),children:[(e===N.EVENT||e===N.INTERVAL)&&(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer time column"),hovered:!0,name:"annotation-layer-time-column",label:e===N.INTERVAL?(0,p.t)("Interval start column"):(0,p.t)("Event time column"),description:(0,p.t)("This column must contain date/time information."),validationErrors:l?[]:["Mandatory"],clearable:!1,options:n,value:l,onChange:e=>this.setState({timeColumn:e})}),e===N.INTERVAL&&(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer interval end"),hovered:!0,name:"annotation-layer-intervalEnd",label:(0,p.t)("Interval End column"),description:(0,p.t)("This column must contain date/time information."),validationErrors:s?[]:["Mandatory"],options:t,value:s,onChange:e=>this.setState({intervalEndColumn:e})}),(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer title column"),hovered:!0,name:"annotation-layer-title",label:(0,p.t)("Title Column"),description:(0,p.t)("Pick a title for you annotation."),options:[{value:"",label:(0,p.t)("None")}].concat(t),value:i,onChange:e=>this.setState({titleColumn:e})}),e!==N.TIME_SERIES&&(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer description columns"),hovered:!0,name:"annotation-layer-title",label:(0,p.t)("Description Columns"),description:(0,p.t)("Pick one or more columns that should be shown in the annotation. If you don't select a column all of them will be shown."),multi:!0,options:t,value:r,onChange:e=>this.setState({descriptionColumns:e})}),(0,k.FD)("div",{style:{marginTop:"1rem"},children:[(0,k.Y)(w.A,{hovered:!0,name:"annotation-override-time_range",label:(0,p.t)("Override time range"),description:(0,p.t)('This controls whether the "time_range" field from the current\n                  view should be passed down to the chart containing the annotation data.'),value:"time_range"in o,onChange:e=>{delete o.time_range,e?this.setState({overrides:{...o,time_range:null}}):this.setState({overrides:{...o}})}}),(0,k.Y)(w.A,{hovered:!0,name:"annotation-override-timegrain",label:(0,p.t)("Override time grain"),description:(0,p.t)("This controls whether the time grain field from the current\n                  view should be passed down to the chart containing the annotation data."),value:"time_grain_sqla"in o,onChange:e=>{delete o.time_grain_sqla,delete o.granularity,e?this.setState({overrides:{...o,time_grain_sqla:null,granularity:null}}):this.setState({overrides:{...o}})}}),(0,k.Y)(S.A,{hovered:!0,name:"annotation-layer-timeshift",label:(0,p.t)("Time Shift"),description:(0,p.t)("Time delta in natural language\n                  (example:  24 hours, 7 days, 56 weeks, 365 days)"),placeholder:"",value:o.time_shift,onChange:e=>this.setState({overrides:{...o,time_shift:e}})})]})]})})}return""}renderDisplayConfiguration(){const{color:e,opacity:t,style:n,width:a,showMarkers:o,hideLine:i,annotationType:l}=this.state,s=(0,f.A)().get(this.props.colorScheme).colors.concat();return e&&e!==M&&!s.find((t=>t.toLowerCase()===e.toLowerCase()))&&s.push(e),(0,k.FD)(E.A,{isSelected:!0,title:(0,p.t)("Display configuration"),info:(0,p.t)("Configure your how you overlay is displayed here."),children:[(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer stroke"),name:"annotation-layer-stroke",label:(0,p.t)("Style"),options:[{value:"solid",label:(0,p.t)("Solid")},{value:"dashed",label:(0,p.t)("Dashed")},{value:"longDashed",label:(0,p.t)("Long dashed")},{value:"dotted",label:(0,p.t)("Dotted")}],value:n,clearable:!1,onChange:e=>this.setState({style:e})}),(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer opacity"),name:"annotation-layer-opacity",label:(0,p.t)("Opacity"),options:[{value:"",label:(0,p.t)("Solid")},{value:"opacityLow",label:"0.2"},{value:"opacityMedium",label:"0.5"},{value:"opacityHigh",label:"0.8"}],value:t,onChange:e=>this.setState({opacity:e})}),(0,k.FD)("div",{style:{marginTop:2*this.props.theme.sizeUnit,marginBottom:2*this.props.theme.sizeUnit},children:[(0,k.Y)(w.A,{name:"annotation-layer-automatic-color",label:(0,p.t)("Use automatic color"),value:e===M,onChange:e=>{e?this.setState({color:M}):this.setState({color:s[0]||"#000000"})}}),e!==M&&(0,k.FD)("div",{style:{marginTop:2*this.props.theme.sizeUnit},children:[(0,k.Y)(_.A,{label:(0,p.t)("Color")}),(0,k.Y)(u.s,{value:e,presets:[{label:"Theme colors",colors:s}],onChangeComplete:e=>this.setState({color:e.toHexString()}),showText:!0})]})]}),(0,k.Y)(S.A,{name:"annotation-layer-stroke-width",label:(0,p.t)("Line width"),isInt:!0,value:a,onChange:e=>this.setState({width:e})}),l===N.TIME_SERIES&&(0,k.Y)(w.A,{hovered:!0,name:"annotation-layer-show-markers",label:(0,p.t)("Show Markers"),description:(0,p.t)("Shows or hides markers for the time series"),value:o,onChange:e=>this.setState({showMarkers:e})}),l===N.TIME_SERIES&&(0,k.Y)(w.A,{hovered:!0,name:"annotation-layer-hide-line",label:(0,p.t)("Hide Line"),description:(0,p.t)("Hides the Line for the time series"),value:i,onChange:e=>this.setState({hideLine:e})})]})}render(){const{isNew:e,name:t,annotationType:n,sourceType:a,show:o,showLabel:i}=this.state,l=this.isValidForm(),s=(0,y.A)().get(this.props.vizType),r=s?s.supportedAnnotationTypes.map((e=>F[e])):[],h=this.getSupportedSourceTypes(n);return(0,k.FD)(k.FK,{children:[this.props.error&&(0,k.FD)("span",{style:{color:this.props.theme.colorError},children:["ERROR: ",this.props.error]}),(0,k.FD)("div",{style:{display:"flex",flexDirection:"row"},children:[(0,k.Y)("div",{style:{marginRight:"2rem"},children:(0,k.FD)(E.A,{isSelected:!0,title:(0,p.t)("Layer configuration"),info:(0,p.t)("Configure the basics of your Annotation Layer."),children:[(0,k.Y)(S.A,{name:"annotation-layer-name",label:(0,p.t)("Name"),placeholder:"",value:t,onChange:e=>this.setState({name:e}),validationErrors:t?[]:[(0,p.t)("Mandatory")]}),(0,k.Y)(w.A,{name:"annotation-layer-hide",label:(0,p.t)("Hide layer"),value:!o,onChange:e=>this.setState({show:!e})}),(0,k.Y)(w.A,{name:"annotation-label-show",label:(0,p.t)("Show label"),value:i,hovered:!0,description:(0,p.t)("Whether to always show the annotation label"),onChange:e=>this.setState({showLabel:e})}),(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation layer type"),hovered:!0,description:(0,p.t)("Choose the annotation layer type"),label:(0,p.t)("Annotation layer type"),name:"annotation-layer-type",clearable:!1,options:r,value:n,onChange:this.handleAnnotationType}),h.length>0&&(0,k.Y)(T.Ay,{ariaLabel:(0,p.t)("Annotation source type"),hovered:!0,description:(0,p.t)("Choose the source of your annotations"),label:(0,p.t)("Annotation source"),name:"annotation-source-type",options:h,notFoundContent:(0,k.Y)(O,{}),value:a,onChange:this.handleAnnotationSourceType,validationErrors:a?[]:[(0,p.t)("Mandatory")]}),this.renderValueConfiguration()]})}),this.renderSliceConfiguration(),this.renderDisplayConfiguration()]}),(0,k.FD)("div",{style:{display:"flex",justifyContent:"space-between"},children:[e?(0,k.Y)(d.$,{buttonSize:"small",buttonStyle:"secondary",onClick:()=>this.props.close(),children:(0,p.t)("Cancel")}):(0,k.Y)(d.$,{buttonSize:"small",buttonStyle:"secondary",onClick:this.deleteAnnotation,children:(0,p.t)("Remove")}),(0,k.FD)("div",{children:[(0,k.Y)(d.$,{buttonSize:"small",disabled:!l,onClick:this.applyAnnotation,children:(0,p.t)("Apply")}),(0,k.Y)(d.$,{buttonSize:"small",buttonStyle:"primary",disabled:!l,onClick:this.submitAnnotation,children:(0,p.t)("OK")})]})]})]})}}U.propTypes=R,U.defaultProps=x;const $=(0,C.b)(U)}}]);